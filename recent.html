<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Dashboard - Multi-Sheet</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .dashboard-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header p {
            color: #666;
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #555;
        }

        .loading {
            color: #ff6b6b;
            font-weight: bold;
        }

        .loaded {
            color: #51cf66;
            font-weight: bold;
        }

        .navigation {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .nav-button {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .nav-button.active {
            background: linear-gradient(45deg, #51cf66 0%, #40c057 100%);
            box-shadow: 0 4px 15px rgba(81, 207, 102, 0.4);
        }

        .export-section {
            background: #f1f3f4;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .export-section h3 {
            margin-top: 0;
            color: #333;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .export-btn {
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .content-panel {
            display: none;
            background: #fff;
            border-radius: 10px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .content-panel.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
        }

        .summary-card .amount {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }

        .balance-positive {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .balance-negative {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }

        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .success-message {
            background: #51cf66;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 20px;
                margin: 10px;
            }
            
            .navigation {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üìä Financial Dashboard</h1>
            <p>Multi-Sheet Google Sheets Integration</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <span id="connection-status" class="loading">üîÑ Connecting...</span>
            </div>
            <div class="status-item">
                <span id="last-updated">Last Updated: Never</span>
            </div>
            <div class="status-item">
                <button onclick="refreshAllData()" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                    üîÑ Refresh Data
                </button>
            </div>
        </div>

        <div class="export-section">
            <h3>üì§ Export Options</h3>
            <div class="export-buttons">
                <button class="export-btn" onclick="exportToPDF('credits')">üí∞ Export Credits</button>
                <button class="export-btn" onclick="exportToPDF('debits')">üí∏ Export Debits</button>
                <button class="export-btn" onclick="exportToPDF('students')">üë• Export Students</button>
                <button class="export-btn" onclick="exportToPDF('balance')">‚öñÔ∏è Export Balance</button>
                <button class="export-btn" onclick="exportToPDF('summary')">üìã Export Summary</button>
                <button class="export-btn" onclick="exportToPDF('all')">üìÑ Export All Data</button>
            </div>
        </div>

        <div class="navigation">
            <button class="nav-button active" onclick="showPanel('credits')">üí∞ Credits</button>
            <button class="nav-button" onclick="showPanel('debits')">üí∏ Debits</button>
            <button class="nav-button" onclick="showPanel('students')">üë• Students</button>
            <button class="nav-button" onclick="showPanel('balance')">‚öñÔ∏è Balance</button>
            <button class="nav-button" onclick="showPanel('recent')">üìã Recent</button>
            <button class="nav-button" onclick="showPanel('alerts')">‚ö†Ô∏è Alerts</button>
        </div>

        <!-- Credits Panel -->
        <div id="credits-panel" class="content-panel active">
            <h2>üí∞ Credit Transactions</h2>
            <div class="summary-card">
                <h3>Total Credits</h3>
                <p class="amount" id="credits-total">$0.00</p>
                <p id="credits-count">0 transactions</p>
            </div>
            <div id="credits-content">
                <div class="no-data">Loading credit data...</div>
            </div>
        </div>

        <!-- Debits Panel -->
        <div id="debits-panel" class="content-panel">
            <h2>üí∏ Debit Transactions</h2>
            <div class="summary-card">
                <h3>Total Debits</h3>
                <p class="amount" id="debits-total">$0.00</p>
                <p id="debits-count">0 transactions</p>
            </div>
            <div id="debits-content">
                <div class="no-data">Loading debit data...</div>
            </div>
        </div>

        <!-- Students Panel -->
        <div id="students-panel" class="content-panel">
            <h2>üë• Students</h2>
            <div class="summary-card">
                <h3>Total Students</h3>
                <p class="amount" id="students-total">0</p>
                <p id="students-status">Active students</p>
            </div>
            <div id="students-content">
                <div class="no-data">Loading student data...</div>
            </div>
        </div>

        <!-- Balance Panel -->
        <div id="balance-panel" class="content-panel">
            <h2>‚öñÔ∏è Balance Overview</h2>
            <div id="balance-summary">
                <div class="summary-card" id="balance-card">
                    <h3>Current Balance</h3>
                    <p class="amount" id="balance-amount">$0.00</p>
                    <p id="balance-status">Calculating...</p>
                </div>
            </div>
            <div id="balance-breakdown">
                <div class="no-data">Loading balance data...</div>
            </div>
        </div>

        <!-- Recent Panel -->
        <div id="recent-panel" class="content-panel">
            <h2>üìã Recent Transactions</h2>
            <div id="recent-content">
                <div class="no-data">Loading recent transactions...</div>
            </div>
        </div>

        <!-- Alerts Panel -->
        <div id="alerts-panel" class="content-panel">
            <h2>‚ö†Ô∏è Alerts & Notifications</h2>
            <div id="alerts-content">
                <div class="no-data">Checking for alerts...</div>
            </div>
        </div>
    </div>

    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Configuration
        const CONFIG = {
            GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwl2547hMsMHLi0l1e9xcq6Ue_eV9wgL4gVWyCIASTZZrY2VY-brzxsqVRsKtYSbRk2/exec',
            SHEETS: {
                CREDITS: 'credit',
                DEBITS: 'debit',
                STUDENTS: 'students'
            },
            RETRY_ATTEMPTS: 3,
            RETRY_DELAY: 1000
        };

        // Global data storage
        let appData = {
            credits: [],
            debits: [],
            students: [],
            lastUpdated: null,
            loading: false
        };

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount || 0);
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            return new Date(date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            
            document.querySelector('.dashboard-container').insertBefore(
                messageDiv, 
                document.querySelector('.navigation')
            );
            
            setTimeout(() => messageDiv.remove(), 5000);
        }

        // API Functions
        async function fetchSheetData(sheetName, retryCount = 0) {
            try {
                const url = `${CONFIG.GOOGLE_SCRIPT_URL}?sheet=${sheetName}`;
                console.log(`Fetching data from: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`${sheetName} data received:`, data);
                
                return data;
                
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                
                if (retryCount < CONFIG.RETRY_ATTEMPTS) {
                    console.log(`Retrying ${sheetName} (attempt ${retryCount + 1}/${CONFIG.RETRY_ATTEMPTS})...`);
                    await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
                    return fetchSheetData(sheetName, retryCount + 1);
                }
                
                throw error;
            }
        }

        async function refreshAllData() {
            if (appData.loading) {
                showMessage('Already loading data, please wait...', 'info');
                return;
            }

            appData.loading = true;
            document.getElementById('connection-status').textContent = 'üîÑ Loading...';
            document.getElementById('connection-status').className = 'loading';

            try {
                // Fetch all sheets in parallel
                const [creditsData, debitsData, studentsData] = await Promise.all([
                    fetchSheetData(CONFIG.SHEETS.CREDITS),
                    fetchSheetData(CONFIG.SHEETS.DEBITS),
                    fetchSheetData(CONFIG.SHEETS.STUDENTS)
                ]);

                // Process the data
                appData.credits = processTransactionData(creditsData, 'Credit');
                appData.debits = processTransactionData(debitsData, 'Debit');
                appData.students = processStudentData(studentsData);
                appData.lastUpdated = new Date();

                // Update UI
                updateAllPanels();
                
                document.getElementById('connection-status').textContent = '‚úÖ Connected';
                document.getElementById('connection-status').className = 'loaded';
                document.getElementById('last-updated').textContent = 
                    `Last Updated: ${appData.lastUpdated.toLocaleString()}`;

                showMessage('Data refreshed successfully!', 'success');

            } catch (error) {
                console.error('Error refreshing data:', error);
                document.getElementById('connection-status').textContent = '‚ùå Error';
                document.getElementById('connection-status').className = 'loading';
                showMessage(`Failed to load data: ${error.message}`, 'error');
            } finally {
                appData.loading = false;
            }
        }

        // Data Processing Functions
        function processTransactionData(rawData, type) {
            const transactions = [];
            
            let dataArray = rawData;
            
            // Handle Google Sheets API response format
            if (rawData.values && Array.isArray(rawData.values)) {
                if (rawData.values.length < 2) return transactions;
                
                const headers = rawData.values[0].map(h => h.toLowerCase());
                dataArray = rawData.values.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                });
            }

            if (Array.isArray(dataArray)) {
                dataArray.forEach((row, index) => {
                    const transaction = {
                        id: `${type.toLowerCase()}_${index}`,
                        date: row.date || row.Date || row.DATE || '',
                        description: row.description || row.Description || row.desc || '',
                        amount: parseFloat(row.amount || row.Amount || 0),
                        type: type,
                        category: row.category || row.Category || '',
                        student: row.student || row.Student || row.student_name || '',
                        notes: row.notes || row.Notes || '',
                        timestamp: new Date(row.date || Date.now())
                    };

                    if (transaction.description || transaction.amount > 0) {
                        transactions.push(transaction);
                    }
                });
            }

            return transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        function processStudentData(rawData) {
            const students = [];
            
            let dataArray = rawData;
            
            if (rawData.values && Array.isArray(rawData.values)) {
                if (rawData.values.length < 2) return students;
                
                const headers = rawData.values[0].map(h => h.toLowerCase());
                dataArray = rawData.values.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                });
            }

            if (Array.isArray(dataArray)) {
                dataArray.forEach((row, index) => {
                    const student = {
                        id: `student_${index}`,
                        name: row.name || row.Name || row.student_name || '',
                        studentId: row.student_id || row.id || row.ID || '',
                        email: row.email || row.Email || '',
                        phone: row.phone || row.Phone || row.contact || '',
                        course: row.course || row.Course || '',
                        batch: row.batch || row.Batch || '',
                        status: row.status || row.Status || 'Active',
                        joinDate: row.join_date || row.joinDate || ''
                    };

                    if (student.name || student.studentId) {
                        students.push(student);
                    }
                });
            }

            return students;
        }

        // UI Update Functions
        function updateAllPanels() {
            updateCreditsPanel();
            updateDebitsPanel();
            updateStudentsPanel();
            updateBalancePanel();
            updateRecentPanel();
            updateAlertsPanel();
        }

        function updateCreditsPanel() {
            const total = appData.credits.reduce((sum, item) => sum + item.amount, 0);
            const count = appData.credits.length;
            
            document.getElementById('credits-total').textContent = formatCurrency(total);
            document.getElementById('credits-count').textContent = `${count} transactions`;
            
            const content = document.getElementById('credits-content');
            
            if (count === 0) {
                content.innerHTML = '<div class="no-data">No credit transactions found</div>';
                return;
            }
            
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Student</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.credits.map(item => `
                            <tr>
                                <td>${formatDate(item.date)}</td>
                                <td>${item.description}</td>
                                <td>${formatCurrency(item.amount)}</td>
                                <td>${item.student || 'N/A'}</td>
                                <td>${item.category || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            content.innerHTML = table;
        }

        function updateDebitsPanel() {
            const total = appData.debits.reduce((sum, item) => sum + item.amount, 0);
            const count = appData.debits.length;
            
            document.getElementById('debits-total').textContent = formatCurrency(total);
            document.getElementById('debits-count').textContent = `${count} transactions`;
            
            const content = document.getElementById('debits-content');
            
            if (count === 0) {
                content.innerHTML = '<div class="no-data">No debit transactions found</div>';
                return;
            }
            
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Student</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.debits.map(item => `
                            <tr>
                                <td>${formatDate(item.date)}</td>
                                <td>${item.description}</td>
                                <td>${formatCurrency(item.amount)}</td>
                                <td>${item.student || 'N/A'}</td>
                                <td>${item.category || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            content.innerHTML = table;
        }

        function updateStudentsPanel() {
            const count = appData.students.length;
            const activeCount = appData.students.filter(s => s.status.toLowerCase() === 'active').length;
            
            document.getElementById('students-total').textContent = count;
            document.getElementById('students-status').textContent = `${activeCount} active students`;
            
            const content = document.getElementById('students-content');
            
            if (count === 0) {
                content.innerHTML = '<div class="no-data">No students found</div>';
                return;
            }
            
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Student ID</th>
                            <th>Email</th>
                            <th>Course</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.students.map(student => `
                            <tr>
                                <td>${student.name}</td>
                                <td>${student.studentId || 'N/A'}</td>
                                <td>${student.email || 'N/A'}</td>
                                <td>${student.course || 'N/A'}</td>
                                <td><span style="color: ${student.status.toLowerCase() === 'active' ? 'green' : 'red'}">${student.status}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            content.innerHTML = table;
        }

        function updateBalancePanel() {
            const totalCredits = appData.credits.reduce((sum, item) => sum + item.amount, 0);
            const totalDebits = appData.debits.reduce((sum, item) => sum + item.amount, 0);
            const balance = totalCredits - totalDebits;
            
            document.getElementById('balance-amount').textContent = formatCurrency(balance);
            document.getElementById('balance-status').textContent = 
                balance >= 0 ? 'Positive Balance' : 'Negative Balance';
            
            const balanceCard = document.getElementById('balance-card');
            balanceCard.className = balance >= 0 ? 'summary-card balance-positive' : 'summary-card balance-negative';
            
            const breakdown = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: #51cf66; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h4 style="margin: 0;">Total Credits</h4>
                        <p style="font-size: 1.5rem; margin: 10px 0;">${formatCurrency(totalCredits)}</p>
                        <p style="margin: 0;">${appData.credits.length} transactions</p>
                    </div>
                    <div style="background: #ff6b6b; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h4 style="margin: 0;">Total Debits</h4>
                        <p style="font-size: 1.5rem; margin: 10px 0;">${formatCurrency(totalDebits)}</p>
                        <p style="margin: 0;">${appData.debits.length} transactions</p>
                    </div>
                </div>
            `;
            
            document.getElementById('balance-breakdown').innerHTML = breakdown;
        }

        function updateRecentPanel() {
            const allTransactions = [...appData.credits, ...appData.debits]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 20);
            
            const content = document.getElementById('recent-content');
            
            if (allTransactions.length === 0) {
                content.innerHTML = '<div class="no-data">No recent transactions found</div>';
                return;
            }
            
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Student</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allTransactions.map(item => `
                            <tr>
                                <td>${formatDate(item.date)}</td>
                                <td><span style="color: ${item.type === 'Credit' ? 'green' : 'red'}">${item.type}</span></td>
                                <td>${item.description}</td>
                                <td>${formatCurrency(item.amount)}</td>
                                <td>${item.student || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            content.innerHTML = table;
        }

        function updateAlertsPanel() {
            const alerts = [];
            
            // Check for negative balance
            const totalCredits = appData.credits.reduce((sum, item) => sum + item.amount, 0);
            const totalDebits = appData.debits.reduce((sum, item) => sum + item.amount, 0);
            const balance = totalCredits - totalDebits;
            
            if (balance < 0) {
                alerts.push({
                    type: 'danger',
                    title: 'Negative Balance Alert',
                    message: `Current balance is ${formatCurrency(balance)}. Account is overdrawn.`
                });
            }
            
            // Check for inactive students
            const inactiveStudents = appData.students.filter(s => s.status.toLowerCase() !== 'active').length;
            if (inactiveStudents > 0) {
                alerts.push({
                    type: 'warning',
                    title: 'Inactive Students',
                    message: `${inactiveStudents} students are currently inactive.`
                });
            }
            
            // Check for recent large transactions
            const largeTransactions = [...appData.credits, ...appData.debits]
                .filter(t => t.amount > 1000)
                .filter(t => (Date.now() - new Date(t.timestamp)) < 7 * 24 * 60 * 60 * 1000);
            
            if (largeTransactions.length > 0) {
                alerts.push({
                    type: 'info',
                    title: 'Large Transactions',
                    message: `${largeTransactions.length} transactions over $1,000 in the past week.`
                });
            }
            
            const content = document.getElementById('alerts-content');
            
            if (alerts.length === 0) {
                content.innerHTML = '<div class="no-data">‚úÖ No alerts at this time</div>';
                return;
            }
            
            const alertsHTML = alerts.map(alert => `
                <div style="background: ${getAlertColor(alert.type)}; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 5px 0;">${getAlertIcon(alert.type)} ${alert.title}</h4>
                    <p style="margin: 0;">${alert.message}</p>
                </div>
            `).join('');
            
            content.innerHTML = alertsHTML;
        }

        function getAlertColor(type) {
            switch(type) {
                case 'danger': return '#ff6b6b';
                case 'warning': return '#ffd43b';
                case 'info': return '#339af0';
                default: return '#667eea';
            }
        }

        function getAlertIcon(type) {
            switch(type) {
                case 'danger': return 'üö®';
                case 'warning': return '‚ö†Ô∏è';
                case 'info': return '‚ÑπÔ∏è';
                default: return 'üì¢';
            }
        }

        // Navigation Functions
        function showPanel(panelName) {
            // Remove active class from all buttons
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            
            // Hide all panels
            document.querySelectorAll('.content-panel').forEach(panel => panel.classList.remove('active'));
            
            // Show selected panel
            const targetPanel = document.getElementById(`${panelName}-panel`);
            if (targetPanel) {
                targetPanel.classList.add('active');
                
                // Add active class to clicked button
                event.target.classList.add('active');
            }
        }

        // PDF Export Functions
        function exportToPDF(reportType) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set up document
            doc.setFontSize(20);
            doc.setTextColor(40, 40, 40);
            
            const totalCredits = appData.credits.reduce((sum, item) => sum + item.amount, 0);
            const totalDebits = appData.debits.reduce((sum, item) => sum + item.amount, 0);
            const balance = totalCredits - totalDebits;
            
            let title = '';
            let filename = '';
            
            // Determine report type
            switch(reportType) {
                case 'credits':
                    title = 'Credits Report';
                    filename = 'credits-report.pdf';
                    break;
                case 'debits':
                    title = 'Debits Report';
                    filename = 'debits-report.pdf';
                    break;
                case 'students':
                    title = 'Students Report';
                    filename = 'students-report.pdf';
                    break;
                case 'balance':
                    title = 'Balance Report';
                    filename = 'balance-report.pdf';
                    break;
                case 'summary':
                    title = 'Financial Summary';
                    filename = 'financial-summary.pdf';
                    break;
                case 'all':
                    title = 'Complete Financial Report';
                    filename = 'complete-report.pdf';
                    break;
                default:
                    title = 'Financial Report';
                    filename = 'financial-report.pdf';
            }
            
            // Add header
            doc.text(title, 20, 30);
            
            // Add metadata
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 45);
            doc.text(`Data Source: Google Sheets`, 20, 55);
            doc.text(`Last Updated: ${appData.lastUpdated ? appData.lastUpdated.toLocaleString() : 'Never'}`, 20, 65);
            
            let yPosition = 85;
            
            // Generate content based on report type
            if (reportType === 'credits') {
                generateCreditsReport(doc, yPosition);
            } else if (reportType === 'debits') {
                generateDebitsReport(doc, yPosition);
            } else if (reportType === 'students') {
                generateStudentsReport(doc, yPosition);
            } else if (reportType === 'balance') {
                generateBalanceReport(doc, yPosition, totalCredits, totalDebits, balance);
            } else if (reportType === 'summary') {
                generateSummaryReport(doc, yPosition, totalCredits, totalDebits, balance);
            } else if (reportType === 'all') {
                generateCompleteReport(doc, yPosition, totalCredits, totalDebits, balance);
            }
            
            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(128);
                doc.text(`Page ${i} of ${pageCount}`, 190, 285, { align: 'right' });
                doc.text('Generated by Financial Dashboard', 20, 285);
            }
            
            // Save the PDF
            doc.save(filename);
            showMessage(`${title} exported successfully!`, 'success');
        }

        function generateCreditsReport(doc, startY) {
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(`Total Credits: ${formatCurrency(appData.credits.reduce((sum, item) => sum + item.amount, 0))}`, 20, startY);
            doc.text(`Transaction Count: ${appData.credits.length}`, 20, startY + 15);
            
            if (appData.credits.length > 0) {
                const tableData = appData.credits.map(item => [
                    formatDate(item.date),
                    item.description,
                    formatCurrency(item.amount),
                    item.student || 'N/A',
                    item.category || 'N/A'
                ]);
                
                doc.autoTable({
                    startY: startY + 30,
                    head: [['Date', 'Description', 'Amount', 'Student', 'Category']],
                    body: tableData,
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: [102, 126, 234] },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    columnStyles: { 2: { halign: 'right' } }
                });
            }
        }

        function generateDebitsReport(doc, startY) {
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(`Total Debits: ${formatCurrency(appData.debits.reduce((sum, item) => sum + item.amount, 0))}`, 20, startY);
            doc.text(`Transaction Count: ${appData.debits.length}`, 20, startY + 15);
            
            if (appData.debits.length > 0) {
                const tableData = appData.debits.map(item => [
                    formatDate(item.date),
                    item.description,
                    formatCurrency(item.amount),
                    item.student || 'N/A',
                    item.category || 'N/A'
                ]);
                
                doc.autoTable({
                    startY: startY + 30,
                    head: [['Date', 'Description', 'Amount', 'Student', 'Category']],
                    body: tableData,
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: [102, 126, 234] },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    columnStyles: { 2: { halign: 'right' } }
                });
            }
        }

        function generateStudentsReport(doc, startY) {
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(`Total Students: ${appData.students.length}`, 20, startY);
            doc.text(`Active Students: ${appData.students.filter(s => s.status.toLowerCase() === 'active').length}`, 20, startY + 15);
            
            if (appData.students.length > 0) {
                const tableData = appData.students.map(student => [
                    student.name,
                    student.studentId || 'N/A',
                    student.email || 'N/A',
                    student.course || 'N/A',
                    student.status
                ]);
                
                doc.autoTable({
                    startY: startY + 30,
                    head: [['Name', 'Student ID', 'Email', 'Course', 'Status']],
                    body: tableData,
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: [102, 126, 234] },
                    alternateRowStyles: { fillColor: [245, 245, 245] }
                });
            }
        }

        function generateBalanceReport(doc, startY, totalCredits, totalDebits, balance) {
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            
            doc.text('Financial Overview', 20, startY);
            doc.text(`Total Credits: ${formatCurrency(totalCredits)}`, 20, startY + 20);
            doc.text(`Total Debits: ${formatCurrency(totalDebits)}`, 20, startY + 35);
            doc.text(`Current Balance: ${formatCurrency(balance)}`, 20, startY + 50);
            doc.text(`Status: ${balance >= 0 ? 'POSITIVE' : 'NEGATIVE - OVERDRAWN'}`, 20, startY + 65);
            
            if (balance < 0) {
                doc.setTextColor(255, 0, 0);
                doc.text(`‚ö†Ô∏è ALERT: Account overdrawn by ${formatCurrency(Math.abs(balance))}`, 20, startY + 85);
            }
        }

        function generateSummaryReport(doc, startY, totalCredits, totalDebits, balance) {
            generateBalanceReport(doc, startY, totalCredits, totalDebits, balance);
            
            // Add summary statistics
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            let currentY = startY + 110;
            
            doc.text('Summary Statistics:', 20, currentY);
            doc.text(`‚Ä¢ Total Transactions: ${appData.credits.length + appData.debits.length}`, 30, currentY + 15);
            doc.text(`‚Ä¢ Credit Transactions: ${appData.credits.length}`, 30, currentY + 30);
            doc.text(`‚Ä¢ Debit Transactions: ${appData.debits.length}`, 30, currentY + 45);
            doc.text(`‚Ä¢ Total Students: ${appData.students.length}`, 30, currentY + 60);
            doc.text(`‚Ä¢ Active Students: ${appData.students.filter(s => s.status.toLowerCase() === 'active').length}`, 30, currentY + 75);
        }

        function generateCompleteReport(doc, startY, totalCredits, totalDebits, balance) {
            // This would be a comprehensive report with all data
            generateSummaryReport(doc, startY, totalCredits, totalDebits, balance);
            
            // Add recent transactions
            const recentTransactions = [...appData.credits, ...appData.debits]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10);
            
            if (recentTransactions.length > 0) {
                doc.addPage();
                doc.setFontSize(14);
                doc.text('Recent Transactions (Last 10)', 20, 30);
                
                const tableData = recentTransactions.map(item => [
                    formatDate(item.date),
                    item.type,
                    item.description,
                    formatCurrency(item.amount),
                    item.student || 'N/A'
                ]);
                
                doc.autoTable({
                    startY: 45,
                    head: [['Date', 'Type', 'Description', 'Amount', 'Student']],
                    body: tableData,
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: [102, 126, 234] },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    columnStyles: { 3: { halign: 'right' } }
                });
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Financial Dashboard Initialized');
            
            // Load data on startup
            refreshAllData();
            
            // Auto-refresh every 5 minutes
            setInterval(() => {
                if (!appData.loading) {
                    console.log('Auto-refreshing data...');
                    refreshAllData();
                }
            }, 5 * 60 * 1000);
        });

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showMessage('An unexpected error occurred. Please refresh the page.', 'error');
        });

        // Handle network connectivity
        window.addEventListener('online', function() {
            showMessage('Connection restored. Refreshing data...', 'success');
            refreshAllData();
        });

        window.addEventListener('offline', function() {
            showMessage('Connection lost. Using cached data.', 'warning');
        });
    </script>
</body>
</html>
